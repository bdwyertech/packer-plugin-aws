Type: `ami-delete`

The `ami-delete` post-processor is used to delete AWS AMIs and their associated EBS snapshots after a Packer build. This is useful for cleanup operations or when you want to remove AMIs that were created as part of a multi-step build process.

## Configuration Reference

This post-processor uses the same AWS authentication configuration as the [Hashicorp Amazon plugin](https://developer.hashicorp.com/packer/integrations/hashicorp/amazon#authentication). All authentication methods supported by that plugin (access keys, profiles, IAM roles, etc.) are available here.

**Optional**

All AWS authentication and configuration options from the Amazon plugin are supported. See the [Amazon plugin authentication documentation](https://developer.hashicorp.com/packer/integrations/hashicorp/amazon#authentication) for details on:
- Access keys and secret keys
- AWS profiles
- IAM role assumption
- Session tokens
- Region configuration

## Example Usage

### Basic Usage

```hcl
packer {
  required_plugins {
    amazon = {
      version = ">= 1.0.0"
      source  = "github.com/hashicorp/amazon"
    }
    aws = {
      version = ">= 0.0.1"
      source  = "github.com/bdwyertech/aws"
    }
  }
}

source "amazon-ebs" "example" {
  region        = "us-east-1"
  source_ami    = "ami-0c55b159cbfafe1f0"
  instance_type = "t2.micro"
  ssh_username  = "ubuntu"
  ami_name      = "temporary-ami-{{timestamp}}"
}

build {
  sources = ["source.amazon-ebs.example"]
  
  post-processor "aws-ami-delete" {
    region = "us-east-1"
  }
}
```

### Multi-Region Cleanup

When your AMI has been copied to multiple regions, the post-processor will automatically detect all regions from the artifact ID and delete the AMI in each region:

```hcl
source "amazon-ebs" "multi-region" {
  region        = "us-east-1"
  source_ami    = "ami-0c55b159cbfafe1f0"
  instance_type = "t2.micro"
  ssh_username  = "ubuntu"
  ami_name      = "multi-region-ami-{{timestamp}}"
  ami_regions   = ["us-west-2", "eu-central-1"]
}

build {
  sources = ["source.amazon-ebs.multi-region"]
  
  # This will delete the AMI in all regions (us-east-1, us-west-2, eu-central-1)
  post-processor "aws-ami-delete" {}
}
```

## How It Works

1. **Validate Builder**: The post-processor verifies that the artifact comes from a supported Amazon builder (EBS, EBS Surrogate, EBS Volume, Chroot, or Instance Store).

2. **Parse Artifact ID**: Extracts the AMI IDs and their regions from the Packer artifact ID (format: `region:ami-id,region:ami-id`).

3. **Locate AMI**: For each AMI, queries AWS to get the full AMI details including associated snapshots.

4. **Deregister AMI**: Deregisters the AMI in each region.

5. **Delete Snapshots**: Deletes all EBS snapshots associated with the AMI's block device mappings.

## Supported Builders

This post-processor works with artifacts from the following Amazon builders:

- `amazon-ebs`
- `amazon-ebssurrogate`
- `amazon-ebsvolume`
- `amazon-chroot`
- `amazon-instance`

## Notes

- **Destructive Operation**: This post-processor permanently deletes AMIs and snapshots. Use with caution.
- **Multi-Region Support**: Automatically handles AMIs that exist in multiple regions based on the artifact ID.
- **Snapshot Cleanup**: All EBS snapshots associated with the AMI are automatically deleted.
- **Permissions Required**: Ensure your AWS credentials have permissions for `ec2:DeregisterImage`, `ec2:DeleteSnapshot`, and `ec2:DescribeImages`.
- **Artifact Preservation**: The post-processor returns the original artifact, so it can be chained with other post-processors if needed.
- **Idempotent**: If an AMI or snapshot has already been deleted, the operation will fail. Ensure AMIs exist before running the post-processor.

## Common Use Cases

### Cleanup After Testing

Delete temporary AMIs created during CI/CD pipeline testing:

```hcl
build {
  sources = ["source.amazon-ebs.test"]
  
  provisioner "shell" {
    inline = ["echo 'Running tests...'"]
  }
  
  post-processor "aws-ami-delete" {
    region = "us-east-1"
  }
}
```

### Conditional Deletion

Use Packer's `only` or `except` directives to conditionally delete AMIs:

```hcl
build {
  sources = ["source.amazon-ebs.example"]
  
  post-processor "manifest" {
    output = "manifest.json"
  }
  
  post-processor "aws-ami-delete" {
    only   = ["source.amazon-ebs.example"]
    region = "us-east-1"
  }
}